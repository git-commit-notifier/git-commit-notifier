#!/usr/bin/env ruby

if RUBY_VERSION < '1.9'
  # This is for Unicode support in Ruby 1.8
  $KCODE = 'u';
  require 'jcode'
end

# Ruby 1.8.6 syntax sugar
unless Symbol.method_defined?(:to_proc)
  class Symbol
    # Turns the symbol into a simple proc, which is especially useful for enumerations. Examples:
    #
    #   # The same as people.collect { |p| p.name }
    #   people.collect(&:name)
    #
    #   # The same as people.select { |p| p.manager? }.collect { |p| p.salary }
    #   people.select(&:manager?).collect(&:salary)
    def to_proc
      Proc.new { |*args| args.shift.__send__(self, *args) }
    end
  end
end

# parameters: revision1, revision 2, branch
THIS_FILE = File.symlink?(__FILE__) ? File.readlink(__FILE__) : __FILE__
$:.unshift File.join(File.dirname(THIS_FILE), "../lib")
require "commit_hook"

case ARGV.length
when 0
  CommitHook.show_error("You have to add a path to the config file for git-commit-notifier")
  puts "Usage:  git-commit-notifier config-script [oldrev newrev [ref]]"
when 1
  oldrev, newrev, ref = STDIN.gets.strip.split
  CommitHook.run ARGV[0], oldrev, newrev, ref
when 2
  CommitHook.run ARGV[0], ARGV[1], ARGV[1], ""
when 3
  CommitHook.run ARGV[0], ARGV[1], ARGV[2], ""
else
  CommitHook.run ARGV[0], ARGV[1], ARGV[2], ARGV[3]
end
